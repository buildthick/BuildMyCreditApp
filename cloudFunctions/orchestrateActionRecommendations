const functions = require('firebase-functions');
const admin = require('firebase-admin');
// To avoid deployment errors, do not call admin.initializeApp() in your code

exports.orchestrateActionRecommendations = functions
  .region('us-central1')
  .https.onCall(async (data, context) => {
    if (!context.auth || !context.auth.uid) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Must be signed in to orchestrate recommendations.'
      );
    }

    const db = admin.firestore();
    const uid = context.auth.uid;
    const userRef = db.doc(`users/${uid}`);
    const planMetaCol = userRef.collection('plan_meta');

    // 1) Get latest cycleId (if any)
    const lastMetaSnap = await planMetaCol
      .orderBy('createdAt', 'desc')
      .limit(1)
      .get();

    let nextCycleNum = 0;

    if (!lastMetaSnap.empty) {
      const last = lastMetaSnap.docs[0].data();
      const prevRaw = last && last.cycleId != null ? last.cycleId : null;
      const prevNum = prevRaw != null ? parseInt(prevRaw, 10) : NaN;

      if (!isNaN(prevNum) && prevNum >= 0) {
        nextCycleNum = prevNum + 1;
      }
    }

    const cycleId = String(nextCycleNum);

    // 2) Compute monthKey (YYYY-MM) from "now"
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const monthKey = `${year}-${month}`;

    // 3) Record this cycle in plan_meta
    // For now, only 'pay' is wired to use cycleId.
    const actionGroupsIncluded = ['pay'];

    await planMetaCol.add({
      cycleId,
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      monthKey,
      actionGroupsIncluded,
      // scope / triggerSource will be added later on "accept"
    });

    // 4) Return the cycleId as STRING (for FF)
    return cycleId;
  });
